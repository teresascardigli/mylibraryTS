---
title: "Tutorial Esteso per mylibraryTS"
author: "Teresa Scardigli"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Tutorial Esteso per mylibraryTS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)

1. Introduzione al Pacchetto mylibraryTS
Il pacchetto mylibraryTS è una raccolta di funzioni ottimizzate con data.table per l'analisi rapida e riproducibile di dati omici ad alto throughput (conteggi genici, metadati di campioni, dati di integrazione e varianti genomiche).

Questa Vignette guida l'utente attraverso tre pipeline di analisi principali, dimostrando come le funzioni lavorano insieme per rispondere agli obiettivi del progetto.

Snippet di codice

library(mylibraryTS)
library(data.table)
library(ggplot2)
```
2. Preparazione dei Dati di Esempio (Simulazione)
Per garantire la riproducibilità del tutorial, generiamo set di dati di esempio che mimano la struttura dei file di input richiesti dalle funzioni.

Snippet di codice

# --- 1. Dati per Analisi Bulk (Esercizio 1, 2) ---
# gene_counts_dt: Conteggi di espressione (gene, sample_id, count)
gene_counts_dt <- data.table(
  gene = c(paste0("GENE_00", 1:3), paste0("GENE_A", 1:3)),
  sample_id = rep(paste0("S", 1:2), each = 3),
  count = c(500, 10, 800, 15, 600, 8)
)
# sample_dt: Metadati del campione (sample_id, condition)
sample_dt <- data.table(
  sample_id = paste0("S", 1:2),
  condition = c("treated", "control"),
  patient_id = c("P1", "P2")
)

# --- 2. Dati per Analisi Integrazione (Final Revision) ---
# integration_dt: Cell ID, Cluster, Tipo di Tessuto (N/T)
integration_dt <- data.table(
  cell = paste0("CELL_", 1:12),
  integration_cluster = rep(c("C1", "C2"), 6),
  sample_type = rep(c("N", "T"), each = 6) # N=Normal, T=Tumor
)
# cell_type_dt: Cell ID e Annotazione Tipo Cellulare
cell_type_dt <- data.table(
  cell = paste0("CELL_", 1:12),
  cell_type = rep(c("B-Cell", "T-Cell", "Macrophage", "Fibroblast"), 3)
)

# --- 3. Dati per Analisi Genomica (Esercizio 11) ---
# variants_dt: Varianti genetiche
variants_dt <- data.table(
  chr = c("chr1", "chr1", "chr2", "chr2", "chr3"),
  pos = c(100, 150, 200, 250, 300),
  impact = c("HIGH", "LOW", "HIGH", "MODERATE", "HIGH"),
  sample_id = c("S1", "S1", "S2", "S3", "S3")
)
# genes_dt: Intervalli di geni
genes_dt <- data.table(
  chr = c("chr1", "chr2"),
  start = c(50, 180),
  end = c(170, 280),
  gene = c("GENE_A", "GENE_B")
)
3. Pipeline 1: Elaborazione Conteggi Bulk (Esercizio 1)
Questa pipeline dimostra le operazioni di filtraggio, aggregazione e join efficienti con data.table.

3.1. Task 1: Somma e Filtro Geni 'GENE_00' (calcola_somma_geni_00_dt)
Filtra i campioni treated e aggrega la somma totale per i geni che iniziano con "GENE_00".

Snippet di codice

somma_filtro_dt <- calcola_somma_geni_00_dt(gene_counts_dt, sample_dt)
print(somma_filtro_dt)
3.2. Task 2: Media e Mediana (calcola_media_mediana_geni_00_dt)
Calcola la media e la mediana dei conteggi per i geni filtrati in Task 1, raggruppando per gene.

Snippet di codice

media_mediana_dt <- calcola_media_mediana_geni_00_dt(gene_counts_dt, sample_dt)
print(media_mediana_dt)
3.3. Task 3: Join in Pipeline (calcola_media_gene_condition_dt)
Esegue il join con i metadati e calcola la media dei conteggi per condition (treated/control) in un'unica catena di comandi.

Snippet di codice

media_condizione_dt <- calcola_media_gene_condition_dt(gene_counts_dt, sample_dt)
print(media_condizione_dt)
4. Pipeline 2: Analisi Dati di Integrazione (Revisione Finale)
Queste funzioni combinano i dati single-cell e generano statistiche e visualizzazioni per tipo cellulare/tessuto/cluster.

4.1. Task 3: Riepilogo Cell Type, Cluster e Tessuto (task3_riepilogo_cluster_celltype_tissue)
Combina i dati di integrazione con le annotazioni del tipo cellulare e crea una tabella di riepilogo.

Snippet di codice

summary_table_dt <- task3_riepilogo_cluster_celltype_tissue(integration_dt, cell_type_dt)
print(summary_table_dt)
4.2. Task 4: Plot Distribuzione Tessuto (task4_plot_distribuzione_tessuto)
Genera un grafico a barre che visualizza la distribuzione del tipo cellulare nei tessuti Normali/Tumorali per ciascun cluster.

Snippet di codice

# La funzione salverebbe un file PNG, qui mostriamo solo l'oggetto ggplot.
plot_dt <- task4_plot_distribuzione_tessuto(summary_table_dt, output_png = "temp_plot.png")
print(plot_dt)
4.3. Task 5: Normalizzazione Percentuale (task5_normalizza_percentuali)
Normalizza i conteggi per calcolare la percentuale di ciascun tipo cellulare all'interno del proprio gruppo (cluster x sample type), un passaggio cruciale per confronti equi.

Snippet di codice

normalized_dt <- task5_normalizza_percentuali(summary_table_dt)
print(head(normalized_dt, 5))
5. Pipeline 3: Analisi Varianti Genomiche (Esercizio 11)
Questa sezione si concentra sull'associazione delle varianti alle regioni geniche e sul riepilogo del loro impatto.

5.1. Task 11a: Mappatura Varianti a Geni (mappa_varianti_a_geni_dt)
Esegue il mapping delle varianti (variants_dt) sulle regioni geniche (genes_dt) utilizzando le coordinate genomiche.

Snippet di codice

mapped_variants_dt <- mappa_varianti_a_geni_dt(variants_dt, genes_dt)
print(mapped_variants_dt)
5.2. Task 11b: Conteggio Varianti High-Impact (conta_varianti_high_impact_dt)
Conta le varianti con impact == "HIGH" raggruppando per gene e campione per identificare i geni più colpiti.

Snippet di codice

high_impact_counts <- conta_varianti_high_impact_dt(mapped_variants_dt)
print(high_impact_counts)

6. Conclusioni
Il pacchetto mylibraryTS raggiunge l'obiettivo di fornire un'alternativa performante (grazie all'ottimizzazione con data.table) per l'esecuzione di analisi complesse e ad alto throughput. La modularità delle funzioni consente agli utenti di assemblare facilmente le pipeline necessarie per le loro esigenze, garantendo al contempo risultati veloci e pienamente riproducibili.
